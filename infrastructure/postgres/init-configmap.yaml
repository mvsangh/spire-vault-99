apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-script
  namespace: 99-apps
data:
  init-db.sql: |
    -- Database Initialization Script for SPIRE-Vault-99
    -- Creates tables and seeds demo users (Brooklyn Nine-Nine theme)

    -- Enable required extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    -- Users table
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        username VARCHAR(50) UNIQUE NOT NULL,
        email VARCHAR(255) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
    );

    -- Create index on username and email for faster lookups
    CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);

    -- GitHub integrations table
    CREATE TABLE IF NOT EXISTS github_integrations (
        id SERIAL PRIMARY KEY,
        user_id INTEGER UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        is_configured BOOLEAN DEFAULT FALSE NOT NULL,
        configured_at TIMESTAMP,
        last_accessed_at TIMESTAMP,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
    );

    -- Create index on user_id for faster lookups
    CREATE INDEX IF NOT EXISTS idx_github_integrations_user_id ON github_integrations(user_id);

    -- Audit log table
    CREATE TABLE IF NOT EXISTS audit_log (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
        action VARCHAR(100) NOT NULL,
        resource_type VARCHAR(50),
        resource_id VARCHAR(100),
        details JSONB,
        ip_address INET,
        user_agent TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
    );

    -- Create indexes on audit_log for faster queries
    CREATE INDEX IF NOT EXISTS idx_audit_log_user_id ON audit_log(user_id);
    CREATE INDEX IF NOT EXISTS idx_audit_log_action ON audit_log(action);
    CREATE INDEX IF NOT EXISTS idx_audit_log_created_at ON audit_log(created_at);

    -- Insert demo users (Brooklyn Nine-Nine theme)
    -- Passwords are bcrypt hashed with cost factor 12
    -- Password format: <username>-precinct99 (e.g., jake-precinct99, amy-precinct99, etc.)

    INSERT INTO users (username, email, password_hash) VALUES
        -- jake / jake-precinct99
        ('jake', 'jake@precinct99.nypd', '$2b$12$6cIHlLJY1WaUpvimu1iuuuVHWnfNjAUGQhUCDmVjapef2fvKPRpiy'),
        -- amy / amy-precinct99
        ('amy', 'amy@precinct99.nypd', '$2b$12$Tvv1nLwWFPMH/zMDHv9ioeEbkAy.San1xClSgZ.YyeB2hW5RSsm2i'),
        -- rosa / rosa-precinct99
        ('rosa', 'rosa@precinct99.nypd', '$2b$12$hgGgM8kdZSXQnoXZaSrDJOhySgzlu2eV79K7ePPYvynGdOmtmeSrO'),
        -- terry / terry-precinct99
        ('terry', 'terry@precinct99.nypd', '$2b$12$LMx4Fpu68YaW0BIqc2Zlqutl1nD0RlYwNo/2SnJ7RRUZQPMrPeA.K'),
        -- charles / charles-precinct99
        ('charles', 'charles@precinct99.nypd', '$2b$12$ctkQ2.ngVs.nYu061L45Cu2.G..HjklQXV1T34e8Ww01s2/mWB65K'),
        -- gina / gina-precinct99
        ('gina', 'gina@precinct99.nypd', '$2b$12$LbpXc29igalUvJdceAm0pOjlSQ0fc7ddKwumSAcfU.ZGmKa04G3G2')
    ON CONFLICT (username) DO NOTHING;

    -- Create updated_at trigger function
    CREATE OR REPLACE FUNCTION update_updated_at_column()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.updated_at = CURRENT_TIMESTAMP;
        RETURN NEW;
    END;
    $$ language 'plpgsql';

    -- Create triggers for updated_at
    DROP TRIGGER IF EXISTS update_users_updated_at ON users;
    CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
        FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

    DROP TRIGGER IF EXISTS update_github_integrations_updated_at ON github_integrations;
    CREATE TRIGGER update_github_integrations_updated_at BEFORE UPDATE ON github_integrations
        FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

    -- Verify setup
    DO $$
    DECLARE
        user_count INTEGER;
    BEGIN
        SELECT COUNT(*) INTO user_count FROM users;
        RAISE NOTICE 'âœ… Database initialized successfully!';
        RAISE NOTICE 'Total users: %', user_count;
    END $$;
