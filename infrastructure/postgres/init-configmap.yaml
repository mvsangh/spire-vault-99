apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-script
  namespace: 99-apps
data:
  init-db.sql: |
    -- Database initialization script for SPIRE-Vault-99 demo
    -- Brooklyn Nine-Nine themed user data

    -- Enable password encryption
    CREATE EXTENSION IF NOT EXISTS pgcrypto;

    -- Users table (stores user accounts)
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        username VARCHAR(50) UNIQUE NOT NULL,
        email VARCHAR(100) UNIQUE,
        password_hash VARCHAR(255) NOT NULL,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
    );

    -- GitHub integration metadata
    CREATE TABLE IF NOT EXISTS github_integrations (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
        is_configured BOOLEAN DEFAULT FALSE,
        configured_at TIMESTAMP,
        last_accessed TIMESTAMP,
        UNIQUE(user_id)
    );

    -- Audit log (optional - for demo purposes)
    CREATE TABLE IF NOT EXISTS audit_log (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
        action VARCHAR(100) NOT NULL,
        resource VARCHAR(100),
        timestamp TIMESTAMP DEFAULT NOW(),
        details JSONB
    );

    -- Indexes for performance
    CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
    CREATE INDEX IF NOT EXISTS idx_github_integrations_user_id ON github_integrations(user_id);
    CREATE INDEX IF NOT EXISTS idx_audit_log_timestamp ON audit_log(timestamp DESC);

    -- Seed demo users (Brooklyn Nine-Nine characters)
    -- Passwords are bcrypt hashed with cost factor 12
    -- Password format: <username>99 (e.g., jake99, amy99, etc.)

    INSERT INTO users (username, email, password_hash) VALUES
      ('jake', 'jake.peralta@99.precinct', '$2b$12$ynvd/p1hHWdM3MwBpv6Xh.kEN4vU9KCBZYUIkXLRyaX5o.ArCoyzi'),
      ('amy', 'amy.santiago@99.precinct', '$2b$12$kUQXIo3KUl0munUJfwVcSOKXwlzJYC33DBBlAF6TbFFWVraRlkiv2'),
      ('rosa', 'rosa.diaz@99.precinct', '$2b$12$.8rTuqEY.hemd08NXDG31eGi3A8J6kbPWMgz1pKdxG4/PGQsbxaS2'),
      ('terry', 'terry.jeffords@99.precinct', '$2b$12$cfbURIWuw5/OKTNR4nAMyOF/sxMotsDDQwh/OXIo2ZEG07xtyPJju'),
      ('charles', 'charles.boyle@99.precinct', '$2b$12$PWxz4OBsyV4vW5ixnTJz5.E.Zn9rPDk.wnkL4/CJQpMbHLsBgLNdS'),
      ('gina', 'gina.linetti@99.precinct', '$2b$12$jqLkaxLiPyYaMGvH705LQu9meczkpsLnJz8/xhjxyISUBHAXJxPXW')
    ON CONFLICT (username) DO NOTHING;

    -- Log the initialization
    DO $$
    BEGIN
        RAISE NOTICE 'Database initialized successfully!';
        RAISE NOTICE 'Demo users created: jake, amy, rosa, terry, charles, gina';
        RAISE NOTICE 'Password format: <username>99 (e.g., jake99)';
    END $$;
